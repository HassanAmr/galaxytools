<tool id="music" name="MUSIC" version="0.1.0">
    <description>An algorithm for identification of enriched regions at multiple scales in the read depth signals from ChIP-Seq experiments</description>
    <requirements>
        <requirement type="package" version="1.0.0">music</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" />
    </stdio>
    <command><![CDATA[
        #if str($options) == "-preprocess"
            MUSIC $options $infile_format $infile $output_dir
        #elif str($options) == "-sort_reads"
            MUSIC $options $reads_dir $output_dir
        #elif str($options) == "-remove_duplicates"
            MUSIC $options $sorted_reads_dir $no_max_duplicates $output_dir
        #else
            -chip $chip_dir
            -control $control_reads_dir
            -mapp $mapp_dir
            -begin_l $begin_l
            -end_l $end_l
            -step $step
            -l_bin $l_bin

            #if str($l_mapp)
                -l_mapp $l_mapp
            #end if

            -mapp_thr $mapp_thr
            -l_frag $l_frag
            -l_c $l_c

            #if str($l_p)
                -l_p $l_p
            #end if

            -sigma $sigma
            -gamma $gamma

            #if str($q_val)
                -q_val $q_val
            #end if

            #if str($options) == "-get_per_win_p_vals_vs_FC":
                -l_win_min $l_win_min
                -l_win_max $l_win_max
                -l_win_step $l_win_step
            #end if
            ;
            mkdir SSERs;
            mkdir ERs;
            mv SSERs*.bed SSERs/;
            mv ERs*.bed ERs/
        #end if

    ]]></command>
    <inputs>
        <param name="options" type="select" label="Options">
            <option value="-preprocess">Preprocess</option>
            <option value="-sort_reads">Sort Reads</option>
            <option value="-remove_duplicates">Remove Duplicates</option>
            <option value="-get_multiscale_broad_ERs">Get Multiscale Broad ERs</option>
            <option value="-get_multiscale_punctate_ERs">Get Multiscale Punctate ERs</option>
            <option value="-get_TF_peaks">Get TF Peaks</option>
            <option value="-write_MS_decomposition">Write MS Decomposition</option>
            <option value="-write_logR_signal">Write LogR Signal</option>
            <option value="-get_per_win_p_vals_vs_FC">Get per win_p values vs. FC</option>
            <option value="-get_scale_spectrum">Get Scale Spectrum</option>
            <option value="-get_multiscale_music">Get Multiscale Music</option>
        </param>
        <param type="data" name="infile" help="Input file"/>
        <param name="infile_format" type="text" value="" help="Input file format ('SAM', 'ELAND', 'bowtie', 'tagAlign', 'BED5', 'BED6')"/>
        <param name="reads_dir" type="text" value="." help="Reads directory"/>
        <param name="output_dir" type="text" value="." help="Output directory"/>
        <param name="sorted_reads_dir" type="text" value="." help="Sorted reads directory"/>
        <param name="no_max_duplicates" type="integer" value="0" help="Max # of duplicates per position"/>
        <param name="chip_dir" type="text" value="." help="ChIP reads directory"/>
        <param name="control_reads_dir" type="text" value="." help="control reads directory"/>
        <param name="mapp_dir" type="text" value="." help="multi-mapability profiles directory"/>
        <param name="begin_l" type="integer" value="1000" help="First scale smoothing window length"/>
        <param name="end_l" type="integer" value="16000" help="Last scale smoothing window length"/>
        <param name="step" type="float" value="1.5" help="Multiplicative window length step"/>
        <param name="l_bin" type="integer" value="5" help="Bin size in nucleotides"/>
        <param name="l_mapp" type="integer" value="" optional="True" help="Read length of multi-mapability profiles"/>
        <param name="mapp_thr" type="float" value="1.2" help="Multi-mapability signal threshold used in correction"/>
        <param name="l_frag" type="integer" value="200" help="Fragment length"/>
        <param name="l_c" type="integer" value="2000" help="Mapability correction window length"/>
        <param name="l_p" type="integer" value="" optional="True" help="Normalization window length for p-value computation"/>
        <param name="sigma" type="float" value="0.5" help="min(Fore/Back, Back/Fore)"/>
        <param name="gamma" type="integer" value="4" help="Min threshold for unsmoothed/smoothed"/>
        <param name="q_val" type="integer" value="" optional="True" help="Maximum q-value for the reported ERs"/>
        <param name="l_win_min" type="integer" value="100" help="Minimum p-val window length"/>
        <param name="l_win_max" type="integer" value="5000" help="Maximum p-val window length"/>
        <param name="l_win_step" type="integer" value="250" help="p-val window length step"/>
    </inputs>
    <outputs>
        <data name="output1" format="txt" from_work_dir="chr_ids.txt" />
        <data name="output2" format="txt" from_work_dir="*_mapped_reads.txt" />
        <data format="bed" name="SSERs_report">
            <discover_datasets pattern="__designation_and_ext__" directory="SSERs" visible="true" />
        </data>
        <data format="bed" name="ERs_report">
            <discover_datasets pattern="__designation_and_ext__" directory="ERs" visible="true" />
        </data>
    </outputs>
    <tests>
        <test>
            <param name="infile" value="input.sam"/>
            <param name="infile_format" value="SAM"/>
            <param name="options" value="-preprocess"/>
            <output name="output1" file="chr_ids.txt"/>
            <output name="output2" file="*_mapped_reads.txt"/>
        </test>
    </tests>
    <help>
<![CDATA[

MUSIC is an algorithm for identification of enriched regions at multiple scales in the read depth signals from ChIP-Seq experiments.
It takes as input:
- Mapped ChIP and control reads (optional),
- Smoothing scale window lengths (in base pairs),

and outputs:
- Enriched regions at multiple scales,
- Significantly enriched regions from all the scales.

Unlike other ER identification methods, MUSIC allows analyzing the scale length spectrum of ChIP-Seq datasets and also selecting a user specific slice in the scale length spectrum with custom granularity and generates the enriched regions at each length scale.
MUSIC does not strictly require a control experiment (for example mock IP, input DNA) to be performed. It is, however, strongly advised to generate control datasets matching the sample of interest (See Landt et al 2012).

USAGE: MUSIC [options] [arguments]

Options:
    Read Preprocessing:
        -preprocess [File format ("SAM"/"ELAND"/"bowtie"/"tagAlign"/"BED5"/"BED6")] [Mapped reads file path ("stdin" for piped input)] [Output directory]
        -sort_reads [Reads directory] [Output directory]
        -remove_duplicates [Sorted reads directory] [Max # of duplicates per position] [Output directory]
    Peak Selection:
        -get_multiscale_broad_ERs [Options/Values]
        -get_multiscale_punctate_ERs [Options/Values]
        -get_TF_peaks [Options/Values]
    Profile Outputs:
        -write_MS_decomposition [Options/Values]
        -write_logR_signal [Options/Values]
    Parametrization Options:
        -get_per_win_p_vals_vs_FC [Options/Values]
        -get_scale_spectrum [Options/Values]
    Recreative Options (Fun with ChIP-Seq):
        -get_multiscale_music [Options/Values]

Parameters that work with all the options:
    -chip [ChIP reads directory]
    -control [control reads directory]
    -mapp [multi-mapability profiles directory]
    -begin_l [First scale smoothing window length (1000)]
    -end_l [Last scale smoothing window length (16000)]
    -step [Multiplicative window length step (1.5)]
    -l_bin [Bin size in nucleotides (5)]
    -l_mapp [Read length of multi-mapability profiles]
    -mapp_thr [Multi-mapability signal threshold used in correction (1.2)]
    -l_frag [Fragment length (200)]
    -l_c [Mapability correction window length (2000)]
    -l_p [Normalization window length for p-value computation]
    -sigma [min(Fore/Back, Back/Fore) (.5)]
    -gamma [Min threshold for unsmoothed/smoothed (4)]
    -q_val [Maximum q-value for the reported ERs]
Parameters for -get_per_win_p_vals_vs_FC:
    -l_win_min [Minimum p-val window length (100)]
    -l_win_max [Maximum p-val window length (5000)]
    -l_win_step [p-val window length step (250)]

]]>
    </help>
    <citations>
        <citation type="doi">10.1186/s13059-014-0474-3</citation>
    </citations>
</tool>
